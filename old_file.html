<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper Roster & Ownership Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
     <link href="https://fonts.googleapis.com/css2?family=Product+Sans:wght@100;200;300;400;500;700;900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Google+Sans:100,200,300,400,500,600,700" rel="stylesheet">
    <style>
        body {
            font-family: 'Product Sans';
            background-color: #010c20;
            color: #e0e6ed;
        }
        
        #header-container {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #010c20;
            padding-bottom: 0.2rem;
        }

        /* --- Roster View Styles --- */
        #rosterContainer { width: 100%; overflow-x: auto; }
        #rosterGrid { display: flex; flex-direction: row; flex-wrap: nowrap; gap: 0.25rem; min-width: min-content; }
        .roster-column { width: 135px; flex-shrink: 0; }
        .team-header-item { 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            font-size: 0.7rem; 
            font-weight: 300; 
            color: #f4f7fb; 
            text-align: center; 
            padding: 0.1rem; 
            background-color: #0f172a; 
            border: 1px solid #214067; 
            border-bottom: 1px solid #38455c; 
            border-radius: 8px 8px 0 0; 
            cursor: pointer;
        }
        .team-card { background-color: #0f172a; border: 1px solid #214067; border-top: none; border-radius: 0 0 8px 8px; padding: 0.25rem; display: flex; flex-direction: column; gap: 0.25rem; }
        .roster-section h3 { font-size: 0.7rem; font-weight: 400; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 0.2rem; padding-left: 4px; }
        .starters-section h3 { color: #91C7BF; }
        .bench-section h3 { color: #91A3C7; }
        .taxi-section h3 { color: #C7C791; }
        .picks-section h3 { color: #BDA1DA; }
        .qb-section h3 { color: #ff7ab2; }
        .rb-section h3 { color: #82e0ca; }
        .wr-section h3 { color: #a0c2f7; }
        .te-section h3 { color: #d1b3ff; }
        .player-row, .pick-row { padding: 3px 2px; border-radius: 4px; cursor: default; }
        .is-trade-mode .player-row, .is-trade-mode .pick-row { cursor: pointer; }
        .player-selected {
            box-shadow: 0 0 0 2px #685dfc !important;
            background-color: #2e287a !important;
        }
        .pick-row { display: flex; align-items: center; }
        .roster-section .player-row:nth-child(odd), .roster-section .pick-row:nth-child(odd) { background-color: #111e35; }
        .roster-section .player-row:nth-child(even), .roster-section .pick-row:nth-child(even) { background-color: #182842; }
        .player-tag { 
            flex-shrink: 0; 
            width: 20px; 
            height: 15px; 
            border-radius: 3px; 
            font-size: 9px; 
            font-weight: 700; 
            display: grid; 
            place-items: center; 
            color: #000000; 
            text-transform: uppercase; 
        }
        .player-info-wrapper { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; gap: 2px; }
        .player-name-line { display: flex; align-items: center; gap: 5px; }
        .player-name { font-weight: 300; font-size: 11px; color: #e7ecf2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .player-meta-line, .player-value-line { display: flex; align-items: center; gap: 5px; font-size: 10px; color: #8ca2c4; padding-left: 2px; }
        .player-meta-line > span, .player-meta-line > div, .player-value-line > span { font-weight: 400; }
        .player-meta-line .separator, .player-value-line .separator { color: #64748b; }
        .team-tag { 
            display: grid; 
            place-items: center; 
            padding: 0 3px; 
            height: 13px; 
            border-radius: 3px; 
            font-size: 9px; 
            font-weight: 500; 
            background-color: #e8eaed; 
        }
        .player-value-line .value { font-weight: 500; font-size: 11px; }
        .pick-row { justify-content: space-between; }
        .pick-label { font-weight: 400; font-size: 11px; }
        .pick-ktc { text-align: right; font-weight: 500; font-size: 11px; color: #aab8d0; }
        .pick-ktc-value { font-weight: 500; }

        /* --- Player List View Styles --- */
        #playerListView { width: fit-content; margin: 0 auto; }
        #playerSearch { background: #0f2141; border: 1px solid #214067; color: #e0e6ed; padding: 8px 12px; border-radius: 8px; font-size: 14px; width: 280px; max-width: 100%; margin: 1rem auto; display: block; }
        #playerSearch::placeholder { color: #9fb1cf; }
        .player-list-section { border-radius: 6px; overflow: hidden; }
        .pl-player-row { display: flex; align-items: center; padding: 2px 6px; font-size: 12px; }
        .player-list-section .pl-player-row:nth-child(odd) { background: #212635; }
        .player-list-section .pl-player-row:nth-child(even) { background: #1e232d; }
        .pl-player-info { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .pl-player-name { font-size: 12px; font-weight: 400; color: #e7ecf2; display: flex; align-items: center; }
        .pl-player-details { font-size: 10px; color: #8ca2c4; font-weight: 400; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pl-list-tag { min-width: 28px; height: 17px; line-height: 17px; font-size: 11px; font-weight: 400; text-align: center; border-radius: 3px; margin-right: 6px; color: #fff; flex: 0 0 auto; }
        .pl-list-tag-spacer { width: 34px; height: 1px; flex: 0 0 auto; }
        .pl-right-meta {
            margin-left: 8px;
            display: grid;
            grid-template-columns: 28px 36px 1fr; /* Let leagues column be flexible within the fixed parent */
            column-gap: 8px;
            align-items: center;
            font-size: 10px;
            color: #9fb1cf;
            font-weight: 500;
            flex-shrink: 0;
            width: 180px; /* Fixed width for the entire meta block */
        }
        .pl-col-count, .pl-col-pct { text-align: center; }
        .pl-col-lgs { text-align: left; white-space: normal; }
        .pl-list-header { background: #0f1b2f !important; color: #91a3c7; text-transform: uppercase; letter-spacing: .6px; font-weight: 500; }
        .pl-list-header .pl-player-name { font-size: 11px; }
        .pl-list-header .pl-player-details { display: none; }
        .pl-count-high { color: #baf5d1; }
        .pl-count-mid { color: #cfe8ff; }
        .pl-count-low { color: #e5dbff; }
        .pl-pct-high { color: #baf5d1; }
        .pl-pct-mid { color: #cfe8ff; }
        .pl-pct-low { color: #e5dbff; }

        /* --- General UI --- */
        #loading, #welcome-screen { text-align: center; padding: 4rem 2rem; font-size: 1.2rem; color: #9fb1cf; background-color: #0f172a; border: 1px solid #214067; border-radius: 8px; }
        #welcome-screen h2 { font-size: 1.5rem; font-weight: 500; color: #f4f7fb; margin-bottom: 0.5rem; }
        #formatIndicator { font-size: 0.8rem; font-weight: 500; margin-left: 0.5rem; }
        .format-1qb { color: #58a7ff; }
        .format-sflx { color: #ec4899; }

        /* --- Team Compare Styles --- */
        .team-compare-checkbox {
            appearance: none;
            background-color: transparent;
            width: 0.75rem; /* Final Reduced size */
            height: 0.75rem; /* Final Reduced size */
            border: 1.5px solid #64748b;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .team-compare-checkbox.selected {
            background-color: transparent;
            border-color: #685dfc;
        }
        .team-compare-checkbox.selected::after {
            content: '';
            position: absolute;
            background-color: #685dfc;
            width: 0.375rem; /* Final Reduced size */
            height: 0.375rem; /* Final Reduced size */
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .view-switcher button.active {
            background-color: #4f46e5;
            color: white;
        }
       
        /* --- Positional Filter Styles --- */
        .filter-btn {
            background-color: transparent;
            border: none;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-btn[data-position="QB"] { color: #ff2a6d; }
        .filter-btn[data-position="RB"] { color: #00ceb8; }
        .filter-btn[data-position="WR"] { color: #58a7ff; }
        .filter-btn[data-position="TE"] { color: #ffae58; }
        .filter-btn[data-position="FLX"] { color: #a855f7; }
        
        .filter-btn.active[data-position="QB"] { background-color: #ff2a6d; color: #010c20; }
        .filter-btn.active[data-position="RB"] { background-color: #00ceb8; color: #010c20; }
        .filter-btn.active[data-position="WR"] { background-color: #58a7ff; color: #010c20; }
        .filter-btn.active[data-position="TE"] { background-color: #ffae58; color: #010c20; }
        .filter-btn.active[data-position="FLX"] { background-color: #a855f7; color: #010c20; }

        /* --- Trade Simulator Styles --- */
        #tradeSimulator {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #0f172a;
            border-top: 2px solid #334155;
            padding: 0.25rem;
            z-index: 20;
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            max-height: 33vh;
        }
        .trade-header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.25rem; }
        .trade-header h3 { font-size: 0.8rem; font-weight: 500; color: #cbd5e1; }
        #clearTradeButton { background: #475569; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; }
        .trade-body { display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; overflow-y: auto; }
        .trade-team-column { background: #1e293b; border-radius: 6px; padding: 0.25rem; display: flex; flex-direction: column; }
        .trade-team-column h4 { font-size: 0.7rem; font-weight: 500; margin-bottom: 0.25rem; text-align: center; }
        .trade-assets { min-height: 20px; display: flex; flex-wrap: wrap; gap: 3px; align-content: flex-start; flex-grow: 1; }
        .trade-asset-chip { background: #334155; font-size: 0.65rem; padding: 1px 4px; border-radius: 4px; display: flex; gap: 4px; align-items: center; }
        .trade-asset-chip .ktc { font-weight: 500; }
        .trade-total { margin-top: 0.25rem; text-align: right; font-size: 0.75rem; font-weight: 500; }
    </style>
</head>
<body class="p-2 sm:p-4">
    <div id="header-container">
        <header class="bg-slate-800/50 p-2 rounded-lg shadow-lg flex flex-col md:flex-row items-center justify-between gap-2">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <input type="text" id="usernameInput" placeholder="Sleeper Username" value="The_Oracle" class="w-full min-w-0 bg-slate-900 border-2 border-slate-700 focus:border-indigo-500 focus:ring-indigo-500 rounded-lg py-1 px-3 text-white placeholder-slate-500 transition-colors text-xs">
                <button id="fetchRostersButton" class="bg-slate-400 hover:bg-slate-500 text-white font-normal py-1 px-3 text-xs rounded-lg transition-colors whitespace-nowrap">Rosters</button>
                <button id="fetchOwnershipButton" class="bg-slate-700 hover:bg-slate-800 text-white font-normal py-1 px-3 text-xs rounded-lg transition-colors whitespace-nowrap border border-slate-500">Ownership %</button>
            </div>
            <div id="rosterControls" class="flex items-center gap-2 w-full md:w-auto">
                <div class="flex items-center gap-1">
                    <button id="compareButton" class="bg-pink-600 text-white font-semi-bold py-1 px-3 text-xs rounded-lg whitespace-nowrap disabled:bg-slate-600 disabled:text-slate-400 disabled:cursor-not-allowed" disabled>Compare</button>
                    <button id="clearCompareButton" class="text-xs text-slate-400 hover:text-white underline hidden">Clear</button>
                </div>
                <select id="leagueSelect" class="bg-slate-900 border-2 border-slate-700 rounded-lg py-1 px-3 text-white w-full text-xs" disabled>
                    <option>Select a league...</option>
                </select>
                <span id="formatIndicator" class="hidden"></span>
            </div>
        </header>
        <div id="view-controls" class="flex flex-nowrap justify-center items-center p-2 gap-1">
             <div class="view-switcher flex p-0.5 bg-slate-800 rounded-lg">
                <button id="positionalViewBtn" class="px-1.5 py-0.5 text-xs font-normal rounded-md transition-colors">Positional</button>
                <button id="depthChartViewBtn" class="px-1.5 py-0.5 text-xs font-normal rounded-md transition-colors">Depth Chart</button>
            </div>
            <div id="positional-filters" class="flex p-0.5 bg-slate-800 rounded-lg">
                <button data-position="QB" class="filter-btn px-1.5 py-0.5 text-xs font-semi-bold rounded-md transition-colors">QB</button>
                <button data-position="RB" class="filter-btn px-1.5 py-0.5 text-xs font-semi-bold rounded-md transition-colors">RB</button>
                <button data-position="WR" class="filter-btn px-1.5 py-0.5 text-xs font-semi-bold rounded-md transition-colors">WR</button>
                <button data-position="TE" class="filter-btn px-1.5 py-0.5 text-xs font-semi-bold rounded-md transition-colors">TE</button>
                <button data-position="FLX" class="filter-btn px-1.5 py-0.5 text-xs font-semi-bold rounded-md transition-colors">FLX</button>
            </div>
        </div>
    </div>
    <main id="content" class="container mx-auto">
        <div id="welcome-screen">
            <h2>Welcome to the Sleeper Tool</h2>
            <p>Enter a Sleeper username and click 'Rosters' or 'Ownership %' to get started.</p>
        </div>
        <div id="loading" class="hidden">Loading...</div>
        
        <!-- View for Roster Grid -->
        <div id="rosterView" class="hidden">
            <div id="rosterContainer">
                 <div id="rosterGrid"></div>
            </div>
        </div>

        <!-- View for Player List -->
        <div id="playerListView" class="hidden">
            <!-- Content will be generated by JS -->
        </div>
    </main>

    <div id="tradeSimulator">
        <!-- Content generated by JS -->
    </div>

    <script>
        // --- DOM Elements ---
        const usernameInput = document.getElementById('usernameInput');
        const fetchRostersButton = document.getElementById('fetchRostersButton');
        const fetchOwnershipButton = document.getElementById('fetchOwnershipButton');
        const leagueSelect = document.getElementById('leagueSelect');
        const rosterControls = document.getElementById('rosterControls');
        const loadingIndicator = document.getElementById('loading');
        const welcomeScreen = document.getElementById('welcome-screen');
        const formatIndicator = document.getElementById('formatIndicator');
        const rosterView = document.getElementById('rosterView');
        const playerListView = document.getElementById('playerListView');
        const rosterContainer = document.getElementById('rosterContainer');
        const rosterGrid = document.getElementById('rosterGrid');
        const compareButton = document.getElementById('compareButton');
        const clearCompareButton = document.getElementById('clearCompareButton');
        const positionalViewBtn = document.getElementById('positionalViewBtn');
        const depthChartViewBtn = document.getElementById('depthChartViewBtn');
        const viewControls = document.getElementById('view-controls');
        const positionalFiltersContainer = document.getElementById('positional-filters');
        const tradeSimulator = document.getElementById('tradeSimulator');
        const mainContent = document.getElementById('content');

        // --- State ---
        let state = { userId: null, leagues: [], players: {}, oneQbData: {}, sflxData: {}, currentLeagueId: null, isSuperflex: false, cache: {}, teamsToCompare: new Set(), isCompareMode: false, currentRosterView: 'positional', activePositions: new Set(), tradeBlock: {} };
        const assignedLeagueColors = new Map();
        let nextColorIndex = 0;
        const assignedRyColors = new Map();
        let nextRyColorIndex = 0;

        // --- Constants ---
        const API_BASE = 'https://api.sleeper.app/v1';
        const GOOGLE_SHEET_ID = '1MDTf1IouUIrm4qabQT9E5T0FsJhQtmaX55P32XK5c_0';
        const TAG_COLORS = { QB:"#ff2a6d", RB:"#00ceb8", WR:"#58a7ff", TE:"#ffae58", BN:"#475569", TX:"#677588", FLX: "#a855f7", SFLX: "#ff1d7b" };
        const TAG_BORDER_COLORS = { QB:"#5c1f34", RB:"#1e5952", WR:"#2c4a6e", TE:"#6b4a23" };
        const STARTER_ORDER = ['QB', 'RB', 'WR', 'TE', 'FLEX', 'SUPER_FLEX'];
        const TEAM_COLORS = { ARI:"#97233F", ATL:"#A71930", BAL:"#241773", BUF:"#00338D", CAR:"#0085CA", CHI:"#0B162A", CIN:"#FB4F14", CLE:"#311D00", DAL:"#003594", DEN:"#FB4F14", DET:"#0076B6", GB:"#203731", HOU:"#03202F", IND:"#002C5F", JAX:"#006778", KC:"#E31837", LAC:"#0080C6", LAR:"#003594", LV:"#A5ACAF", MIA:"#008E97", MIN:"#4F2683", NE:"#002244", NO:"#D3BC8D", NYG:"#0B2265", NYJ:"#125740", PHI:"#004C54", PIT:"#FFB612", SEA:"#69BE28", SF:"#B3995D", TB:"#D50A0A", TEN:"#4B92DB", WAS:"#5A1414", FA: "#64748b" };
        const LEAGUE_COLOR_PALETTE = ['#e8d28a', '#bfeee5', '#d9d0ff', '#cfe9ff', '#ffd6e7', '#d9ffcf', '#ffc7a8', '#a8d8ff', '#f2c8ff', '#c8ffde'];
        const RY_COLOR_PALETTE = ['#d7f2ff', '#cfe9ff', '#e0f6ea', '#fff1d6', '#efe2ff', '#ffe0ea', '#e4f0ff'];
        const LEAGUE_ABBR_OVERRIDES = { "Big Boofers Club(BBC)": "BBC", "Dynasty footballers": "DFBS", "FF D-League": "DL", "La Leaguaaa dynasty est2024": "LLGA", "The Most Important League": "TMIL", "Trade, Hoard, Eat. League": "THE" };

        // --- Event Listeners ---
        fetchRostersButton.addEventListener('click', handleFetchRosters);
        fetchOwnershipButton.addEventListener('click', handleFetchOwnership);
        leagueSelect.addEventListener('change', handleLeagueSelect);
        rosterGrid.addEventListener('click', handleTeamSelect);
        mainContent.addEventListener('click', handleAssetClickForTrade);
        compareButton.addEventListener('click', handleCompareClick);
        clearCompareButton.addEventListener('click', handleClearCompare);
        positionalViewBtn.addEventListener('click', () => setRosterView('positional'));
        depthChartViewBtn.addEventListener('click', () => setRosterView('depth'));
        positionalFiltersContainer.addEventListener('click', handlePositionFilter);
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            setLoading(true, 'Loading initial data...');
            await Promise.all([ fetchSleeperPlayers(), fetchDataFromGoogleSheet() ]);
            setLoading(false);
            welcomeScreen.classList.remove('hidden');
            viewControls.classList.add('hidden'); // Initially hide view controls
        });

        // --- View Toggling and Main Handlers ---
        function setRosterView(view) {
            state.currentRosterView = view;
            positionalViewBtn.classList.toggle('active', view === 'positional');
            depthChartViewBtn.classList.toggle('active', view === 'depth');
            if (state.currentTeams) {
                renderAllTeamData(state.currentTeams);
            }
        }

        function updateButtonStates(activeButton) {
            // --- Reset to Neutral States ---
            // Rosters Button: slate-400 bg, white text
            fetchRostersButton.classList.remove('bg-slate-300', 'text-slate-900');
            fetchRostersButton.classList.add('bg-slate-400', 'text-white');

            // Ownership Button: slate-700 bg
            fetchOwnershipButton.classList.remove('bg-slate-600');
            fetchOwnershipButton.classList.add('bg-slate-700');

            // --- Apply Active State ---
            if (activeButton === 'rosters') {
                // Rosters active: slate-300 bg, slate-900 text
                fetchRostersButton.classList.replace('bg-slate-400', 'bg-slate-300');
                fetchRostersButton.classList.replace('text-white', 'text-slate-900');
            } else if (activeButton === 'ownership') {
                // Ownership active: slate-600 bg
                fetchOwnershipButton.classList.replace('bg-slate-700', 'bg-slate-600');
            }
        }

        async function handleFetchRosters() {
            const username = usernameInput.value.trim();
            if (!username) return;
            
            setLoading(true, 'Fetching user leagues...');
            
            try {
                await fetchAndSetUser(username);
                const leagues = await fetchUserLeagues(state.userId);
                state.leagues = leagues.sort((a, b) => a.name.localeCompare(b.name));
                
                updateButtonStates('rosters');
                rosterControls.classList.remove('hidden');
                playerListView.classList.add('hidden');
                rosterView.classList.remove('hidden');
                viewControls.classList.remove('hidden');
                setRosterView('positional'); // Set default view
                
                populateLeagueSelect(state.leagues);

                if (state.leagues.length > 0) {
                    leagueSelect.selectedIndex = 1;
                    await handleLeagueSelect();
                }
            } catch (error) {
                handleError(error, username);
            } finally {
                setLoading(false);
            }
        }

        async function handleFetchOwnership() {
            const username = usernameInput.value.trim();
            if (!username) return;
            
            setLoading(true, 'Fetching ownership data...');

            try {
                await fetchAndSetUser(username);
                
                updateButtonStates('ownership');
                rosterControls.classList.add('hidden');
                rosterView.classList.add('hidden');
                playerListView.classList.remove('hidden');
                viewControls.classList.add('hidden');

                await renderPlayerList();
            } catch (error) {
                handleError(error, username);
            } finally {
                setLoading(false);
            }
        }

        async function handleLeagueSelect() {
            const leagueId = leagueSelect.value;
            if (!leagueId || leagueId === 'Select a league...') {
                rosterView.classList.add('hidden');
                return;
            };
            
            state.currentLeagueId = leagueId;
            handleClearCompare(); // Clear compare state on league change
            const leagueInfo = state.leagues.find(l => l.league_id === leagueId);
            const leagueName = leagueInfo?.name || 'league';
            setLoading(true, `Loading ${leagueName}...`);
            rosterGrid.innerHTML = '';

            try {
                const rosterPositions = leagueInfo.roster_positions;
                const superflexSlots = rosterPositions.filter(p => p === 'SUPER_FLEX').length;
                const qbSlots = rosterPositions.filter(p => p === 'QB').length;
                state.isSuperflex = (superflexSlots > 0) || (qbSlots > 1);
                
                formatIndicator.textContent = state.isSuperflex ? 'SFLX' : '1QB';
                formatIndicator.classList.toggle('format-sflx', state.isSuperflex);
                formatIndicator.classList.toggle('format-1qb', !state.isSuperflex);
                formatIndicator.classList.remove('hidden');

                const [rosters, users, tradedPicks] = await Promise.all([
                    fetchWithCache(`${API_BASE}/league/${leagueId}/rosters`),
                    fetchWithCache(`${API_BASE}/league/${leagueId}/users`),
                    fetchWithCache(`${API_BASE}/league/${leagueId}/traded_picks`),
                ]);
                
                const teams = processRosterData(rosters, users, tradedPicks, leagueInfo);
                
                // Automatically select the user's team for comparison
                const userTeam = teams.find(team => team.isUserTeam);
                if (userTeam) {
                    state.teamsToCompare.add(userTeam.teamName);
                }
                updateCompareButtonState();

                renderAllTeamData(teams);
                
                rosterView.classList.remove('hidden');

            } catch (error) {
                console.error(`Error loading league ${leagueId}:`, error);
            } finally {
                setLoading(false);
            }
        }
        
        // --- Compare & Trade Logic ---
        function handleTeamSelect(e) {
            const header = e.target.closest('.team-header-item');
            if (header) {
                const checkbox = header.querySelector('.team-compare-checkbox');
                const teamName = checkbox.dataset.teamName;
                checkbox.classList.toggle('selected');
                if (state.teamsToCompare.has(teamName)) {
                    state.teamsToCompare.delete(teamName);
                } else {
                    state.teamsToCompare.add(teamName);
                }
                updateCompareButtonState();
            }
        }

        function handleCompareClick() {
            state.isCompareMode = !state.isCompareMode;
            rosterView.classList.toggle('is-trade-mode', state.isCompareMode);
            updateCompareButtonState();
            renderAllTeamData(state.currentTeams); 
            renderTradeBlock();
        }

        function handleClearCompare() {
            state.teamsToCompare.clear();
            state.isCompareMode = false;
            rosterView.classList.remove('is-trade-mode');
            document.querySelectorAll('.team-compare-checkbox.selected').forEach(el => el.classList.remove('selected'));
            updateCompareButtonState();
            clearTrade();
            if (state.currentTeams) {
                renderAllTeamData(state.currentTeams);
            }
        }

        function updateCompareButtonState() {
            const count = state.teamsToCompare.size;
            compareButton.disabled = count < 2;
            clearCompareButton.classList.toggle('hidden', count === 0);

            if (state.isCompareMode) {
                compareButton.textContent = 'Show All';
                compareButton.classList.replace('bg-pink-600', 'bg-pink-800');
            } else {
                compareButton.textContent = 'Compare';
                compareButton.classList.replace('bg-pink-800', 'bg-pink-600');
            }
            
            if (count < 2 && state.isCompareMode) {
                handleCompareClick(); // Automatically exit compare mode
            }
        }

        function handleAssetClickForTrade(e) {
            if (!state.isCompareMode) return;

            const assetRow = e.target.closest('.player-row, .pick-row');
            if (!assetRow) return;

            const teamName = assetRow.closest('.roster-column')?.dataset.teamName;
            if (!teamName || !state.teamsToCompare.has(teamName)) return;

            const { assetId, assetLabel, assetKtc } = assetRow.dataset;
            if (!assetId) return;

            // Initialize trade block for the team if it doesn't exist
            if (!state.tradeBlock[teamName]) {
                state.tradeBlock[teamName] = [];
            }

            const assetIndex = state.tradeBlock[teamName].findIndex(a => a.id === assetId);

            if (assetIndex > -1) {
                // Asset is already selected, so remove it
                state.tradeBlock[teamName].splice(assetIndex, 1);
                assetRow.classList.remove('player-selected');
            } else {
                // Asset not selected, so add it
                state.tradeBlock[teamName].push({
                    id: assetId,
                    label: assetLabel,
                    ktc: parseInt(assetKtc, 10) || 0
                });
                assetRow.classList.add('player-selected');
            }
            
            renderTradeBlock();
        }

        function clearTrade() {
            state.tradeBlock = {};
            document.querySelectorAll('.player-selected').forEach(el => el.classList.remove('player-selected'));
            renderTradeBlock();
        }


        // --- Position Filter Logic ---
        function handlePositionFilter(e) {
            if (e.target.tagName !== 'BUTTON') return;
            const btn = e.target;
            const position = btn.dataset.position;
            const flexPositions = ['RB', 'WR', 'TE'];

            if (position === 'FLX') {
                const isActivating = !state.activePositions.has('FLX');
                state.activePositions.clear();
                if (isActivating) {
                    flexPositions.forEach(p => state.activePositions.add(p));
                    state.activePositions.add('FLX');
                }
            } else {
                state.activePositions.delete('FLX');
                if (state.activePositions.has(position)) {
                    state.activePositions.delete(position);
                } else {
                    state.activePositions.add(position);
                }
            }
            
            updatePositionFilterButtons();
            renderAllTeamData(state.currentTeams);
        }
        
        function updatePositionFilterButtons() {
            const buttons = positionalFiltersContainer.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                const pos = btn.dataset.position;
                btn.classList.toggle('active', state.activePositions.has(pos));
            });
        }


        // --- Data Fetching & Processing ---
        async function fetchAndSetUser(username) {
            const userRes = await fetchWithCache(`${API_BASE}/user/${username}`);
            if (!userRes || !userRes.user_id) throw new Error('User not found.');
            state.userId = userRes.user_id;
        }

        async function fetchUserLeagues(userId) {
            const currentYear = new Date().getFullYear();
            const leaguesRes = await fetchWithCache(`${API_BASE}/user/${userId}/leagues/nfl/${currentYear}`);
            if (!leaguesRes || leaguesRes.length === 0) throw new Error(`No leagues found for this user for ${currentYear}.`);
            return leaguesRes;
        }

        async function fetchSleeperPlayers() {
            try { state.players = await fetchWithCache(`${API_BASE}/players/nfl`); } catch (e) { console.error("Failed to fetch Sleeper players:", e); }
        }
        
        async function fetchDataFromGoogleSheet() {
            const sheetNames = { oneQb: 'KTC_1QB', sflx: 'KTC_SFLX' };
            try {
                const [oneQbCsv, sflxCsv] = await Promise.all([
                    fetch(`https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetNames.oneQb}`).then(res => res.text()),
                    fetch(`https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetNames.sflx}`).then(res => res.text())
                ]);
                state.oneQbData = parseSheetData(oneQbCsv);
                state.sflxData = parseSheetData(sflxCsv);
            } catch (e) { console.error("Fatal Error: Could not fetch data from Google Sheet.", e); }
        }

        function parseSheetData(csvText) {
            const dataMap = {};
            const lines = csvText.split(/\r?\n/).slice(1);
            lines.forEach(line => {
                const columns = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                if (columns.length < 13) return;
                const clean = (str) => str ? str.replace(/"/g, '').trim() : '';
                const pos = clean(columns[2]);
                const sleeperId = clean(columns[12]);
                const adp = parseFloat(clean(columns[11]));
                const ktcValue = parseInt(clean(columns[6]), 10);
                if (pos === 'RDP') {
                    const pickName = clean(columns[1]);
                    if (pickName) dataMap[pickName] = { adp: null, ktc: ktcValue };
                } else if (sleeperId && sleeperId !== 'NA') {
                    dataMap[sleeperId] = { adp: isNaN(adp) ? null : adp, ktc: isNaN(ktcValue) ? null : ktcValue };
                }
            });
            return dataMap;
        }

        function processRosterData(rosters, users, tradedPicks, leagueInfo) {
            const userMap = users.reduce((acc, user) => ({ ...acc, [user.user_id]: user }), {});
            const rosterPositions = leagueInfo.roster_positions;
            const taxiSlots = leagueInfo.settings.taxi_slots || 0;

            const teams = rosters.map(roster => {
                const owner = userMap[roster.owner_id];
                const allPlayers = roster.players || [];
                
                const starterIds = roster.starters || [];
                const starters = starterIds.map((playerId, index) => {
                    const slot = rosterPositions[index] || 'FLEX';
                    return getPlayerData(playerId, slot);
                }).sort((a, b) => STARTER_ORDER.indexOf(a.slot) - STARTER_ORDER.indexOf(b.slot));

                const currentTaxiPlayers = (roster.taxi || []).map(p => getPlayerData(p, 'TX')).sort((a, b) => (b.ktc || 0) - (a.ktc || 0));
                const emptyTaxiSlots = Array(Math.max(0, taxiSlots - currentTaxiPlayers.length)).fill({ isPlaceholder: true });
                const taxi = [...currentTaxiPlayers, ...emptyTaxiSlots];

                const bench = allPlayers.filter(pId => pId && !starterIds.includes(pId) && !(roster.taxi || []).includes(pId));
                const draftPicks = getOwnedPicks(roster.roster_id, tradedPicks, leagueInfo);
                
                return {
                    isUserTeam: roster.owner_id === state.userId,
                    teamName: owner?.display_name || `Team ${roster.roster_id}`,
                    starters,
                    bench: bench.map(p => getPlayerData(p, 'BN')).sort((a, b) => (b.ktc || 0) - (a.ktc || 0)),
                    taxi,
                    draftPicks: draftPicks.map(p => getPickData(p, leagueInfo)),
                    allPlayers: allPlayers.map(pId => getPlayerData(pId, '')) // For positional view
                };
            });
            
            state.currentTeams = teams; // Cache the full list of teams for the league

            return teams.sort((a, b) => {
                if (a.isUserTeam) return -1;
                if (b.isUserTeam) return 1;
                return a.teamName.localeCompare(b.teamName);
            });
        }
        
        function getOwnedPicks(rosterId, tradedPicks, leagueInfo) {
            const defaultRounds = leagueInfo.settings.draft_rounds || 5;
            const leagueSeason = parseInt(leagueInfo.season);
            const firstPickSeason = leagueSeason + 1;
            let ownedPicks = [];

            for (let i = 0; i < 4; i++) {
                const season = firstPickSeason + i;
                for (let round = 1; round <= defaultRounds; round++) {
                    ownedPicks.push({ season: String(season), round, original_owner_id: rosterId });
                }
            }

            tradedPicks.forEach(pick => {
                if (pick.roster_id === rosterId && pick.owner_id !== rosterId) {
                    const i = ownedPicks.findIndex(p => p.season === pick.season && p.round === pick.round && p.original_owner_id === rosterId);
                    if (i > -1) ownedPicks.splice(i, 1);
                }
                if (pick.owner_id === rosterId && pick.roster_id !== rosterId) {
                    if (parseInt(pick.season) >= firstPickSeason) {
                        ownedPicks.push({ season: pick.season, round: pick.round, original_owner_id: pick.roster_id });
                    }
                }
            });
            ownedPicks = ownedPicks.filter(p => parseInt(p.season) < 2029);
            return ownedPicks.sort((a, b) => a.season.localeCompare(b.season) || a.round - b.round);
        }

        function getPlayerData(playerId, slot) {
            const player = state.players[playerId];
            if (!player) return { id: playerId, name: 'Unknown Player', pos: '?', age: '?', team: '?', adp: null, ktc: null, slot };
            const valueData = state.isSuperflex ? state.sflxData[playerId] : state.oneQbData[playerId];
            let lastName = player.last_name || '';
            if (lastName.includes('-')) lastName = lastName.split('-')[0];
            let displayName = `${player.first_name.charAt(0)}. ${lastName}`;
            if (displayName.length > 15) displayName = displayName.substring(0, 14) + '…';

            return { id: playerId, name: displayName, pos: player.position || '?', age: player.age || '?', team: player.team || 'FA', adp: valueData?.adp || null, ktc: valueData?.ktc || null, slot };
        }

        function getPickData(pick) {
            const { season, round } = pick;
            const label = `${season} ${ordinalSuffix(round)}`;
            const staticVals = { oneqb: { 1: 5200, 2: 3200, 3: 2000, 4: 1200, 5: 400 }, sflx: { 1: 4300, 2: 2600, 3: 1700, 4: 1000, 5: 400 } };
            let ktc = null;
            if (parseInt(season) >= 2028 || round >= 5) {
                ktc = (state.isSuperflex ? staticVals.sflx : staticVals.oneqb)[round] || null;
            } else {
                const sfx = round === 1 ? 'st' : round === 2 ? 'nd' : round === 3 ? 'rd' : 'th';
                const ktcKey = `${season} Mid ${round}${sfx}`;
                const dataSet = state.isSuperflex ? state.sflxData : state.oneQbData;
                ktc = dataSet[ktcKey]?.ktc || null;
            }
            return { label, ktc, id: `${season}-${round}-${pick.original_owner_id}` };
        }

        // --- UI Rendering ---
        function populateLeagueSelect(leagues) {
            leagueSelect.innerHTML = '<option>Select a league...</option>';
            leagues.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.league_id;
                opt.textContent = l.name;
                leagueSelect.appendChild(opt);
            });
            leagueSelect.disabled = false;
        }

        function renderAllTeamData(teams) {
            rosterGrid.innerHTML = '';
            let teamsToRender = teams;
            if (state.isCompareMode) {
                teamsToRender = teams.filter(team => state.teamsToCompare.has(team.teamName));
            }

            teamsToRender.forEach(team => {
                const columnWrapper = document.createElement('div');
                columnWrapper.className = 'roster-column';
                columnWrapper.dataset.teamName = team.teamName;
                
                const header = document.createElement('div');
                header.className = 'team-header-item';
                
                const checkbox = document.createElement('div');
                checkbox.className = 'team-compare-checkbox';
                if (state.teamsToCompare.has(team.teamName)) {
                    checkbox.classList.add('selected');
                }
                checkbox.dataset.teamName = team.teamName;
                
                const teamNameSpan = document.createElement('span');
                teamNameSpan.textContent = team.teamName;
                
                header.appendChild(checkbox);
                header.appendChild(teamNameSpan);
                
                const card = state.currentRosterView === 'positional' ? createPositionalTeamCard(team) : createDepthChartTeamCard(team);
                
                columnWrapper.appendChild(header);
                columnWrapper.appendChild(card);
                rosterGrid.appendChild(columnWrapper);
            });
        }

        function createDepthChartTeamCard(team) {
            const card = document.createElement('div');
            card.className = 'team-card';
            card.innerHTML = `<div class="roster-section starters-section"><h3>Starters</h3></div><div class="roster-section bench-section"><h3>Bench</h3></div><div class="roster-section taxi-section"><h3>Taxi</h3></div><div class="roster-section picks-section"><h3>Draft Picks</h3></div>`;
            
            const filterActive = state.activePositions.size > 0;
            const filterFunc = player => !filterActive || state.activePositions.has(player.pos) || (state.activePositions.has('FLX') && ['RB', 'WR', 'TE'].includes(player.pos));

            const populate = (sel, data, creator, teamName) => {
                const el = card.querySelector(sel);
                const filteredData = data.filter(item => item.isPlaceholder || filterFunc(item));
                
                const h3 = el.querySelector('h3');
                el.innerHTML = '';
                el.appendChild(h3);

                if (filteredData.length > 0) {
                    filteredData.forEach(item => el.appendChild(creator(item, teamName)));
                } else {
                    el.innerHTML += `<div class="text-xs text-slate-500 p-1 italic">None</div>`;
                }
            };

            populate('.starters-section', team.starters, createPlayerRow, team.teamName);
            populate('.bench-section', team.bench, createPlayerRow, team.teamName);
            populate('.taxi-section', team.taxi, createTaxiRow, team.teamName);
            
            const picksEl = card.querySelector('.picks-section');
            const picksH3 = picksEl.querySelector('h3');
            picksEl.innerHTML = '';
            picksEl.appendChild(picksH3);
            if (team.draftPicks && team.draftPicks.length > 0) {
                team.draftPicks.forEach(item => picksEl.appendChild(createPickRow(item, team.teamName)));
            } else {
                picksEl.innerHTML += `<div class="text-xs text-slate-500 p-1 italic">None</div>`;
            }
            return card;
        }

        function createPositionalTeamCard(team) {
            const card = document.createElement('div');
            card.className = 'team-card';
            card.innerHTML = `
                <div class="roster-section qb-section"><h3>QB</h3></div>
                <div class="roster-section rb-section"><h3>RB</h3></div>
                <div class="roster-section wr-section"><h3>WR</h3></div>
                <div class="roster-section te-section"><h3>TE</h3></div>
                <div class="roster-section picks-section"><h3>Draft Picks</h3></div>
            `;

            const filterActive = state.activePositions.size > 0;

            const positions = {
                QB: team.allPlayers.filter(p => p.pos === 'QB').sort((a, b) => (b.ktc || 0) - (a.ktc || 0)),
                RB: team.allPlayers.filter(p => p.pos === 'RB').sort((a, b) => (b.ktc || 0) - (a.ktc || 0)),
                WR: team.allPlayers.filter(p => p.pos === 'WR').sort((a, b) => (b.ktc || 0) - (a.ktc || 0)),
                TE: team.allPlayers.filter(p => p.pos === 'TE').sort((a, b) => (b.ktc || 0) - (a.ktc || 0)),
            };

            const populate = (sel, data, creator, teamName) => {
                const el = card.querySelector(sel);
                const pos = sel.split('-')[0].toUpperCase().replace('.', '');
                
                const h3 = el.querySelector('h3');
                el.innerHTML = '';
                el.appendChild(h3);

                if (!filterActive || state.activePositions.has(pos) || (state.activePositions.has('FLX') && ['RB', 'WR', 'TE'].includes(pos))) {
                    el.style.display = 'block';
                    if (data && data.length > 0) {
                        data.forEach(item => el.appendChild(creator(item, teamName)));
                    } else {
                        el.innerHTML += `<div class="text-xs text-slate-500 p-1 italic">None</div>`;
                    }
                } else {
                    el.style.display = 'none';
                }
            };

            populate('.qb-section', positions.QB, createPlayerRow, team.teamName);
            populate('.rb-section', positions.RB, createPlayerRow, team.teamName);
            populate('.wr-section', positions.WR, createPlayerRow, team.teamName);
            populate('.te-section', positions.TE, createPlayerRow, team.teamName);
            
            const picksEl = card.querySelector('.picks-section');
            const picksH3 = picksEl.querySelector('h3');
            picksEl.innerHTML = '';
            picksEl.appendChild(picksH3);
            if (team.draftPicks && team.draftPicks.length > 0) {
                team.draftPicks.forEach(item => picksEl.appendChild(createPickRow(item, team.teamName)));
            } else {
                picksEl.innerHTML += `<div class="text-xs text-slate-500 p-1 italic">None</div>`;
            }
            return card;
        }

        function createEmptyTaxiRow() {
            const row = document.createElement('div');
            row.className = 'player-row';
            row.innerHTML = `<span style="color: #475569; font-style: italic; font-size: 11px; padding: 13px 4px; display: block; width: 100%; text-align: center;">Empty Slot</span>`;
            return row;
        }
        
        function createTaxiRow(item, teamName) {
            if (item.isPlaceholder) return createEmptyTaxiRow();
            return createPlayerRow(item, teamName);
        }

        function createPlayerRow(player, teamName) {
            const row = document.createElement('div');
            row.className = 'player-row';
            row.dataset.assetId = player.id;
            row.dataset.assetLabel = player.name;
            row.dataset.assetKtc = player.ktc || 0;

            if (state.isCompareMode && teamName && state.tradeBlock[teamName]?.find(a => a.id === player.id)) {
                row.classList.add('player-selected');
            }

            const adp = player.adp ? player.adp.toFixed(1) : '—';
            const ktc = player.ktc || '—';
            const slotAbbr = { 'SUPER_FLEX': 'SFLX', 'FLEX': 'FLX' };
            const displaySlot = state.currentRosterView === 'depth' ? (slotAbbr[player.slot] || player.slot) : player.pos;
            const teamTagHTML = player.team && player.team !== 'FA' ? `<div class="team-tag" style="color: ${TEAM_COLORS[player.team] || '#64748b'};">${player.team}</div>` : `<span class="player-team">${player.team || 'FA'}</span>`;
            
            // --- To switch styles, comment out one block and uncomment the other ---

            // Original Style (Solid Background)
            let tagHTML = `<div class="player-tag" style="background-color: ${TAG_COLORS[displaySlot] || '#475569'};">${displaySlot}</div>`;

            /*
            // Experimental Style (Bordered)
            const isPrimaryPos = ['QB', 'RB', 'WR', 'TE'].includes(displaySlot);
            if(isPrimaryPos){
                const color = TAG_COLORS[displaySlot];
                const borderColor = TAG_BORDER_COLORS[displaySlot];
                tagHTML = `<div class="player-tag" style="background-color: #383f4e; color: ${color}; border: 0.5px solid ${borderColor};">${displaySlot}</div>`;
            } else {
                tagHTML = `<div class="player-tag" style="background-color: ${TAG_COLORS[displaySlot] || '#475569'};">${displaySlot}</div>`;
            }
            */

            row.innerHTML = `<div class="player-info-wrapper"><div class="player-name-line">${tagHTML}<div class="player-name">${player.name}</div></div><div class="player-meta-line"><span>Age: <span class="player-age">${player.age || '?'}</span></span><span class="separator">•</span><span class="player-pos">${player.pos}</span><span class="separator">•</span>${teamTagHTML}</div><div class="player-value-line"><span>KTC: <span class="value player-ktc">${ktc}</span></span><span class="separator">•</span><span>ADP: <span class="value player-adp">${adp}</span></span></div></div>`;
            
            const ageEl = row.querySelector('.player-age'), posEl = row.querySelector('.player-pos'), adpEl = row.querySelector('.player-adp'), ktcEl = row.querySelector('.player-ktc');
            if (posEl) posEl.style.color = getPosColor(player.pos);
            if (ageEl && player.age) ageEl.style.color = getAgeColorForRoster(player.pos, player.age);
            if (adpEl && player.adp) adpEl.style.color = getAdpColorForRoster(parseFloat(adp));
            if (ktcEl && player.ktc) ktcEl.style.color = getKtcColor(player.ktc);
            return row;
        }

        function createPickRow(pick, teamName) {
            const row = document.createElement('div');
            row.className = 'pick-row';
            row.dataset.assetId = pick.id;
            row.dataset.assetLabel = pick.label;
            row.dataset.assetKtc = pick.ktc || 0;

            if (state.isCompareMode && teamName && state.tradeBlock[teamName]?.find(a => a.id === pick.id)) {
                row.classList.add('player-selected');
            }
            
            const ktcValue = pick.ktc || '—';
            row.innerHTML = `<span class="pick-label">${pick.label}</span><span class="pick-ktc">KTC: <span class="pick-ktc-value">${ktcValue}</span></span>`;
            if (pick.ktc) row.querySelector('.pick-ktc-value').style.color = getKtcColor(pick.ktc);
            return row;
        }

        function renderTradeBlock() {
            if (!state.isCompareMode || state.teamsToCompare.size < 2) {
                tradeSimulator.style.display = 'none';
                mainContent.style.paddingBottom = '1rem';
                return;
            }

            tradeSimulator.style.display = 'flex';
            tradeSimulator.innerHTML = `
                <div class="trade-header">
                    <h3>Trade Preview</h3>
                    <button id="clearTradeButton">Clear</button>
                </div>
                <div class="trade-body"></div>
            `;

            const tradeBody = tradeSimulator.querySelector('.trade-body');
            const teamNames = Array.from(state.teamsToCompare);
            const tradeData = {};

            teamNames.forEach(name => {
                const assets = state.tradeBlock[name] || [];
                const totalKtc = assets.reduce((sum, asset) => sum + asset.ktc, 0);
                tradeData[name] = { assets, totalKtc };
            });

            const totals = teamNames.map(name => tradeData[name].totalKtc);
            const teamColors = {};

            if (teamNames.length === 2) {
                const diff = totals[0] - totals[1];
                if (diff > 1000) {
                    teamColors[teamNames[0]] = '#2dd4bf'; // Teal
                    teamColors[teamNames[1]] = '#fb7185'; // Reddish
                } else if (diff < -1000) {
                    teamColors[teamNames[0]] = '#fb7185'; // Reddish
                    teamColors[teamNames[1]] = '#2dd4bf'; // Teal
                } else {
                    teamColors[teamNames[0]] = '#60a5fa'; // Bluish
                    teamColors[teamNames[1]] = '#60a5fa'; // Bluish
                }
            }


            teamNames.forEach(teamName => {
                const column = document.createElement('div');
                column.className = 'trade-team-column';
                
                const { assets, totalKtc } = tradeData[teamName];

                let assetsHTML = '';
                assets.forEach(asset => {
                    const ktcColor = getKtcColor(asset.ktc);
                    assetsHTML += `<div class="trade-asset-chip"><span>${asset.label}</span><span class="ktc" style="color: ${ktcColor}">(${asset.ktc})</span></div>`;
                });
                
                const totalColor = teamColors[teamName] || 'inherit';

                column.innerHTML = `
                    <h4>${teamName}</h4>
                    <div class="trade-assets">${assetsHTML || '<span class="text-xs text-slate-500">Select assets...</span>'}</div>
                    <div class="trade-total" style="color: ${totalColor}">Total KTC: ${totalKtc}</div>
                `;
                tradeBody.appendChild(column);
            });

            document.getElementById('clearTradeButton').addEventListener('click', clearTrade);
            mainContent.style.paddingBottom = `${tradeSimulator.offsetHeight + 20}px`;
        }


        // --- Player List (Ownership) Functions ---
        async function renderPlayerList() {
            playerListView.innerHTML = '<p class="text-center p-4">Fetching user leagues and rosters...</p>';
            assignedLeagueColors.clear();
            nextColorIndex = 0;
            assignedRyColors.clear();
            nextRyColorIndex = 0;

            const userLeagues = await fetchUserLeagues(state.userId);
            const rostersByLeague = await Promise.all(userLeagues.map(l => fetchWithCache(`${API_BASE}/league/${l.league_id}/rosters`)));

            const agg = new Map();
            rostersByLeague.forEach((rosters, idx) => {
                const leagueName = userLeagues[idx].name;
                const leagueAbbr = getLeagueAbbr(leagueName);
                const myRoster = rosters.find(r => r.owner_id === state.userId || (Array.isArray(r.co_owners) && r.co_owners.includes(state.userId)));
                if (!myRoster) return;
                const pids = new Set((myRoster.players || []).filter(Boolean));
                pids.forEach(pid => {
                    if (!agg.has(pid)) agg.set(pid, new Set());
                    agg.get(pid).add(leagueAbbr);
                });
            });

            const section = document.createElement('div');
            section.className = 'player-list-section';
            
            const header = document.createElement('div');
            header.className = 'pl-player-row pl-list-header';
            
            // Rebuild header programmatically for alignment
            header.innerHTML = ''; // Clear it first
            const tagSpacer = document.createElement('div');
            tagSpacer.className = 'pl-list-tag-spacer';
            header.appendChild(tagSpacer);

            const headerInfo = document.createElement('div');
            headerInfo.className = 'pl-player-info';
            headerInfo.innerHTML = '<div class="pl-player-name">Player & Info</div>';
            header.appendChild(headerInfo);

            const headerMeta = document.createElement('div');
            headerMeta.className = 'pl-right-meta';

            const hCount = document.createElement('span');
            hCount.className = 'pl-col-count';
            hCount.textContent = '#';
            headerMeta.appendChild(hCount);

            const hPct = document.createElement('span');
            hPct.className = 'pl-col-pct';
            hPct.textContent = '%';
            headerMeta.appendChild(hPct);

            const hLgs = document.createElement('span');
            hLgs.className = 'pl-col-lgs';
            hLgs.textContent = 'Leagues';
            headerMeta.appendChild(hLgs);

            header.appendChild(headerMeta);
            section.appendChild(header);

            const rows = Array.from(agg.entries()).map(([pid, leagueSet]) => createPlayerListRow(pid, leagueSet, userLeagues.length)).filter(Boolean);
            rows.sort((a, b) => {
                const countDiff = Number(b.dataset.count || 0) - Number(a.dataset.count || 0);
                if (countDiff !== 0) return countDiff;
                return a.dataset.search.localeCompare(b.dataset.search);
            });

            rows.forEach(r => section.appendChild(r));
            playerListView.innerHTML = '';
            playerListView.appendChild(section);
            
            const searchInput = document.createElement('input');
            searchInput.id = 'playerSearch';
            searchInput.type = 'text';
            searchInput.placeholder = 'Filter players by name...';
            playerListView.prepend(searchInput);

            searchInput.oninput = () => {
                const term = searchInput.value.trim().toLowerCase();
                section.querySelectorAll('.pl-player-row:not(.pl-list-header)').forEach(r => {
                    r.style.display = (r.dataset.search || '').includes(term) ? 'flex' : 'none';
                });
            };
        }

        function createPlayerListRow(pid, leagueSet, totalLeagues) {
            const p = state.players[pid];
            if (!p) return null;

            const pos = p.position || (p.fantasy_positions && p.fantasy_positions[0]) || '';
            const first = (p.first_name || '').trim();
            const last = (p.last_name || '').trim();
            let displayName = `${first} ${last}`.trim() || pid;
            if (first && last) displayName = `${first.charAt(0)}. ${last}`;

            const row = document.createElement('div');
            row.className = 'pl-player-row';
            row.dataset.search = `${first.toLowerCase()} ${last.toLowerCase()} ${displayName.toLowerCase()}`;
            row.dataset.count = leagueSet.size;

            const listTag = document.createElement('div');
            listTag.className = 'pl-list-tag';
            listTag.textContent = pos || '';
            listTag.style.backgroundColor = (pos && TAG_COLORS[pos]) || '#475569';
            
            const playerInfo = document.createElement('div');
            playerInfo.className = 'pl-player-info';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'pl-player-name';
            nameDiv.innerHTML = `
                <span>${displayName}</span>
                <span class="team-tag ml-2" style="color: ${TEAM_COLORS[p.team] || '#475569'};">${p.team || 'FA'}</span>
                ${p.age ? `<span class="ml-1" style="font-size: 9px; color: #aab8d0;">Age: <span style="color:${getAgeColorForRoster(p.position, p.age) || 'inherit'}">${p.age}</span></span>` : ''}
            `;

            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'pl-player-details';
            const detailParts = [];
            const adp1QB = state.oneQbData[pid]?.adp;
            const adpSFLX = state.sflxData[pid]?.adp;
            const rookieYear = deriveRookieYear(p);

            if (adp1QB) detailParts.push(`ADP <span style="color:${getAdpColorForRoster(adp1QB) || 'inherit'}">${adp1QB.toFixed(1)}</span>`);
            if (adpSFLX) detailParts.push(`SFLX <span style="color:${getAdpColorForRoster(adpSFLX) || 'inherit'}">${adpSFLX.toFixed(1)}</span>`);
            if (rookieYear) detailParts.push(`RY <span style="color:${getRyColor(rookieYear) || 'inherit'}">${rookieYear}</span>`);
            detailsDiv.innerHTML = detailParts.join(' • ');

            playerInfo.appendChild(nameDiv);
            playerInfo.appendChild(detailsDiv);

            const rightMeta = document.createElement('div');
            rightMeta.className = 'pl-right-meta';
            const count = document.createElement('span');
            count.className = 'pl-col-count';
            count.textContent = leagueSet.size;
            if (leagueSet.size >= totalLeagues * 0.8) count.classList.add('pl-count-high');
            else if (leagueSet.size >= totalLeagues * 0.5) count.classList.add('pl-count-mid');
            else count.classList.add('pl-count-low');

            const pct = document.createElement('span');
            const pctVal = Math.round((leagueSet.size / totalLeagues) * 100);
            pct.className = 'pl-col-pct';
            pct.textContent = `${pctVal}%`;
            if (pctVal >= 80) pct.classList.add('pl-pct-high');
            else if (pctVal >= 50) pct.classList.add('pl-pct-mid');
            else pct.classList.add('pl-pct-low');
            
            const lgs = document.createElement('span');
            lgs.className = 'pl-col-lgs';
            const sortedAbbrs = Array.from(leagueSet).sort();
            sortedAbbrs.forEach((abbr, index) => {
                const abbrSpan = document.createElement('span');
                abbrSpan.textContent = abbr;
                abbrSpan.style.color = getLeagueColor(abbr);
                lgs.appendChild(abbrSpan);
                if (index < sortedAbbrs.length - 1) lgs.appendChild(document.createTextNode(', '));
            });

            rightMeta.appendChild(count);
            rightMeta.appendChild(pct);
            rightMeta.appendChild(lgs);
            row.appendChild(listTag);
            row.appendChild(playerInfo);
            row.appendChild(rightMeta);
            return row;
        }

        // --- Formatting Helpers ---
        function deriveRookieYear(player) {
            if (!player) return null;
            let ry = player.metadata?.rookie_year ? Number(player.metadata.rookie_year) : 0;
            const exp = player.years_exp;
            const expNum = (exp === '' || exp === null || exp === undefined) ? null : Number(exp);
            if ((!ry || ry === 0) && expNum === 0) {
                return new Date().getFullYear();
            }
            return ry > 0 ? ry : null;
        }
        function getKtcColor(v){const s=[{v:9e3,c:"#00EEB6"},{v:8e3,c:"#14D7CB"},{v:7e3,c:"#0599AA"},{v:6e3,c:"#03a8ce"},{v:5500,c:"#0690DC"},{v:5e3,c:"#066CDC"},{v:4500,c:"#1350fd"},{v:4e3,c:"#5e41ff"},{v:3750,c:"#7158ff"},{v:3500,c:"#964eff"},{v:3250,c:"#9200ff"},{v:3e3,c:"#b70fff"},{v:2750,c:"#ba00cc"},{v:2500,c:"#e800ff"},{v:2250,c:"#db00af"},{v:2e3,c:"#c70097"},{v:0,c:"#FF0080"}];if(v===null||v===0)return"#e0e6ed";for(const t of s)if(v>=t.v)return t.c;return s[s.length-1].c}
        function getPosColor(p){return{QB:"#ff2a6d",RB:"#00ceb8",WR:"#58a7ff",TE:"#ffae58"}[p]||"#e0e6ed"}
        function getAdpColorForRoster(a){const s=[{v:12,c:"#00EEB6"},{v:24,c:"#14D7CB"},{v:36,c:"#0599AA"},{v:48,c:"#03a8ce"},{v:60,c:"#0690DC"},{v:72,c:"#066CDC"},{v:84,c:"#1350fd"},{v:96,c:"#5e41ff"},{v:108,c:"#7158ff"},{v:120,c:"#964eff"},{v:144,c:"#9200ff"},{v:168,c:"#b70fff"},{v:192,c:"#ba00cc"},{v:216,c:"#e800ff"},{v:240,c:"#db00af"},{v:280,c:"#c70097"},{v:320,c:"#FF0080"}];if(!a||a===0)return null;for(const t of s)if(a<=t.v)return t.c;return s[s.length-1].c}
        function getAgeColorForRoster(p,a){const s={wrTe:[{v:22.5,c:"#00ffc4"},{v:25,c:"#85fff3"},{v:26,c:"#56dfe8"},{v:27,c:"#7dd1ff"},{v:29,c:"#89a3ff"},{v:30,c:"#957cff"},{v:31,c:"#a642ff"},{v:32,c:"#cf60ff"},{v:33,c:"#ff6fe1"}],rb:[{v:22.5,c:"#00ffc4"},{v:24,c:"#85fff3"},{v:25,c:"#56dfe8"},{v:26,c:"#7dd1ff"},{v:27,c:"#89a3ff"},{v:28,c:"#957cff"},{v:29,c:"#a642ff"},{v:30,c:"#cf60ff"},{v:31,c:"#ff6fe1"}],qb:[{v:25.5,c:"#00ffc4"},{v:28,c:"#85fff3"},{v:29,c:"#7dd1ff"},{v:31,c:"#48a6ff"},{v:33,c:"#957cff"},{v:36,c:"#a642ff"},{v:40,c:"#cf60ff"},{v:44,c:"#ff6fe1"}]};let sc=p==="WR"||p==="TE"?s.wrTe:p==="RB"?s.rb:p==="QB"?s.qb:null;if(!sc||!a||a===0)return null;for(const t of sc)if(a<=t.v)return t.c;return sc[sc.length-1].c}
        function getLeagueAbbr(name) { if (!name) return "LG"; if (LEAGUE_ABBR_OVERRIDES[name]) return LEAGUE_ABBR_OVERRIDES[name]; if (name.length <= 4 && !name.includes(' ') && !name.includes('-')) return name.toUpperCase(); const words = name.split(/[\s-]+/); let abbr = words.map(w => w[0] || '').join(''); return abbr.toUpperCase(); }
        function getLeagueColor(abbr) { if (!assignedLeagueColors.has(abbr)) { assignedLeagueColors.set(abbr, LEAGUE_COLOR_PALETTE[nextColorIndex % LEAGUE_COLOR_PALETTE.length]); nextColorIndex++; } return assignedLeagueColors.get(abbr); }
        function getRyColor(year) { if (!assignedRyColors.has(year)) { assignedRyColors.set(year, RY_COLOR_PALETTE[nextRyColorIndex % RY_COLOR_PALETTE.length]); nextRyColorIndex++; } return assignedRyColors.get(year); }
        function ordinalSuffix(i){ const j=i%10, k=i%100; if(j===1&&k!==11) return i+'st'; if(j===2&&k!==12) return i+'nd'; if(j===3&&k!==13) return i+'rd'; return i+'th'; }

        // --- Utility Functions ---
        function setLoading(isLoading, message = 'Loading...') {
            welcomeScreen.classList.add('hidden');
            const buttons = [fetchRostersButton, fetchOwnershipButton];
            if (isLoading) {
                loadingIndicator.textContent = message;
                loadingIndicator.classList.remove('hidden');
                buttons.forEach(btn => { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); });
            } else {
                loadingIndicator.classList.add('hidden');
                buttons.forEach(btn => { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); });
            }
        }

        function handleError(error, username) {
            console.error(`Error for user ${username}:`, error);
            welcomeScreen.classList.remove('hidden');
            rosterView.classList.add('hidden');
            playerListView.classList.add('hidden');
            welcomeScreen.innerHTML = `<h2 class="text-red-400">Error</h2><p>Could not fetch data for user: ${username}</p><p>${error.message}</p>`;
        }

        async function fetchWithCache(url) {
            if (state.cache[url]) return state.cache[url];
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
            const data = await response.json();
            state.cache[url] = data;
            return data;
        }
    </script>
</body>
</html>
